<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EXIT No. TETRIS</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050810; --panel: #0a0f1e; --border: #1a2a4a;
  --cyan: #00f5ff; --yellow: #ffe600; --purple: #bf00ff;
  --green: #00ff88; --red: #ff2244; --orange: #ff8800; --blue: #0066ff;
}
body {
  background: var(--bg); color: #eef;
  font-family: 'Share Tech Mono', monospace;
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; overflow: hidden;
}
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);
}
.wrapper { display: flex; gap: 18px; align-items: flex-start; padding: 16px; }
.left-panel, .right-panel { display: flex; flex-direction: column; gap: 12px; width: 130px; }
.game-area { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.title {
  font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1rem;
  letter-spacing: 0.25em; color: var(--cyan);
  text-shadow: 0 0 10px var(--cyan), 0 0 25px var(--cyan); text-align: center;
}
#game-canvas-wrapper { position: relative; }
canvas#gc {
  display: block; border: 2px solid var(--border); background: #060b18;
  box-shadow: 0 0 0 1px #0af4, 0 0 40px rgba(0,200,255,0.12);
}
.panel-box {
  border: 1px solid var(--border); padding: 8px 10px;
  background: var(--panel); position: relative;
}
.panel-box::before {
  content: attr(data-label); position: absolute; top: -7px; left: 7px;
  font-size: 0.5rem; letter-spacing: 0.2em; color: var(--cyan);
  background: var(--panel); padding: 0 4px; text-transform: uppercase;
}
.pval {
  font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700;
  color: var(--yellow); text-shadow: 0 0 8px var(--yellow);
}
canvas.mini-c { display: block; background: transparent; }
.controls { font-size: 0.52rem; line-height: 1.9; color: #4a6a8a; letter-spacing: 0.04em; }
.controls span { color: #8ab; }
#anomaly-bar { width: 300px; height: 5px; background: #111; border: 1px solid #1a2a4a; }
#anomaly-fill { height: 100%; background: var(--green); box-shadow: 0 0 6px var(--green); transition: width 0.2s; }
#decision-area { display: flex; gap: 10px; width: 300px; }
.dec-btn {
  flex: 1; font-family: 'Orbitron', sans-serif; font-size: 0.58rem; font-weight: 700;
  letter-spacing: 0.07em; padding: 7px 4px; background: transparent;
  border: 2px solid; cursor: pointer; text-transform: uppercase; transition: all 0.12s;
}
.dec-btn.exit { border-color: var(--red); color: var(--red); box-shadow: 0 0 6px rgba(255,34,68,0.3); }
.dec-btn.exit:hover { background: var(--red); color: var(--bg); box-shadow: 0 0 18px var(--red); }
.dec-btn.cont { border-color: var(--green); color: var(--green); box-shadow: 0 0 6px rgba(0,255,136,0.3); }
.dec-btn.cont:hover { background: var(--green); color: var(--bg); box-shadow: 0 0 18px var(--green); }
#anomaly-hint {
  font-size: 0.58rem; color: var(--orange); text-align: center; min-height: 1.1em;
  letter-spacing: 0.08em; text-shadow: 0 0 8px var(--orange);
}
@keyframes ablink { 0%,100%{opacity:1}50%{opacity:0.3} }
.blinking { animation: ablink 0.7s infinite; }
#overlay {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: rgba(5,8,16,0.93); gap: 14px; z-index: 10;
}
#overlay h2 {
  font-family: 'Orbitron', sans-serif; font-size: 1.1rem; color: var(--cyan);
  text-shadow: 0 0 15px var(--cyan); letter-spacing: 0.2em; text-align: center;
}
#overlay p {
  font-size: 0.63rem; color: #6a8aaa; letter-spacing: 0.05em;
  text-align: center; max-width: 290px; line-height: 1.85; white-space: pre-wrap;
}
.btn {
  font-family: 'Orbitron', sans-serif; font-size: 0.68rem; font-weight: 700;
  letter-spacing: 0.15em; padding: 9px 22px; background: transparent;
  border: 2px solid var(--cyan); color: var(--cyan); cursor: pointer;
  text-transform: uppercase; box-shadow: 0 0 8px rgba(0,245,255,0.3); transition: all 0.12s;
}
.btn:hover { background: var(--cyan); color: var(--bg); box-shadow: 0 0 20px var(--cyan); }
.result-good  { color: var(--green)  !important; text-shadow: 0 0 15px var(--green)  !important; }
.result-bad   { color: var(--red)    !important; text-shadow: 0 0 15px var(--red)    !important; }
.result-clear { color: var(--yellow) !important; text-shadow: 0 0 20px var(--yellow) !important; font-size: 1.5rem !important; }
.star { width: 11px; height: 11px; background: #1a2a4a; border: 1px solid #2a3a5a; border-radius: 50%; display: inline-block; margin: 1px; }
.star.lit { background: var(--yellow); box-shadow: 0 0 5px var(--yellow); border-color: var(--yellow); }
@keyframes anomPulse {
  0%,100%{box-shadow:0 0 0 1px #0af4,0 0 40px rgba(0,200,255,0.12)}
  50%{box-shadow:0 0 0 2px rgba(255,136,0,0.9),0 0 40px rgba(255,136,0,0.3)}
}
.anomaly-border { animation: anomPulse 1.4s infinite; }
#gp-status {
  position: fixed; bottom: 10px; right: 14px; font-size: 0.55rem;
  letter-spacing: 0.1em; padding: 4px 9px; border-radius: 2px;
  z-index: 1000; opacity: 0; transition: opacity 0.5s;
}
</style>
</head>
<body>
<div class="wrapper">
  <!-- LEFT -->
  <div class="left-panel">
    <div class="panel-box" data-label="HOLD">
      <canvas class="mini-c" id="hold-c" width="110" height="70"></canvas>
    </div>
    <div class="panel-box" data-label="LEVEL">
      <div class="pval" id="level-val">1</div>
      <div id="level-stars" style="margin-top:4px"></div>
    </div>
    <div class="panel-box" data-label="LINES">
      <div class="pval" id="lines-val">0</div>
    </div>
    <div class="panel-box" data-label="ANOMALY">
      <div id="anomaly-count" class="pval" style="font-size:0.72rem;color:var(--orange);text-shadow:0 0 8px var(--orange)">???</div>
    </div>
  </div>

  <!-- GAME -->
  <div class="game-area">
    <div class="title" id="main-title">EXIT No. TETRIS</div>
    <div id="game-canvas-wrapper">
      <canvas id="gc" width="300" height="510"></canvas>
      <div id="overlay">
        <h2 id="ov-title">EXIT No. TETRIS</h2>
        <p id="ov-msg">ãƒ†ãƒˆãƒªã‚¹ã‚’ã—ãªãŒã‚‰ã€Œç•°å¤‰ã€ã‚’æ¢ã›ã€‚

ç•°å¤‰ã‚’æ„Ÿã˜ãŸã‚‰ EXIT ã‚’æŠ¼ã›ã€‚
ç•°å¤‰ãŒãªã‘ã‚Œã° 50ãƒ©ã‚¤ãƒ³ æ¶ˆã›ã€‚

ãƒ¬ãƒ™ãƒ« 8 çªç ´ã§è„±å‡ºæˆåŠŸï¼

ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€‘
åå­—ã‚­ãƒ¼/å·¦Stickï¼šç§»å‹•
A/Bï¼šå³å›è»¢ã€€Xï¼šå·¦å›è»¢ã€€Yï¼š180Â°
LB/RBï¼šãƒ›ãƒ¼ãƒ«ãƒ‰
åå­—â†‘ï¼šãƒãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—
LT/Selectï¼šEXITã€€RTï¼šCONTINUE

ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€‘
â†â†’ï¼šç§»å‹•ã€€â†‘/Xï¼šå³å›è»¢ã€€Zï¼šå·¦å›è»¢ã€€Cï¼š180Â°
â†“ï¼šã‚½ãƒ•ãƒˆã€€Spaceï¼šãƒãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—
Shift/Ctrlï¼šãƒ›ãƒ¼ãƒ«ãƒ‰
Eï¼šEXITã€€Vï¼šCONTINUE</p>
        <button class="btn" id="start-btn">START</button>
      </div>
    </div>
    <div id="anomaly-bar"><div id="anomaly-fill" style="width:0%"></div></div>
    <div id="anomaly-hint"></div>
    <div id="decision-area">
      <button class="dec-btn exit" id="exit-btn">âš  EXIT  [E / LT]</button>
      <button class="dec-btn cont" id="cont-btn">âœ“ CONTINUE  [V / RT]</button>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right-panel">
    <div class="panel-box" data-label="NEXT">
      <canvas class="mini-c" id="next-c" width="110" height="70"></canvas>
    </div>
    <div class="panel-box" data-label="NEXT">
      <canvas class="mini-c" id="next2-c" width="110" height="60"></canvas>
    </div>
    <div class="panel-box" data-label="KEYS">
      <div class="controls">
        <span>â†â†’</span> ç§»å‹•<br>
        <span>â†‘ / X</span> å³å›è»¢<br>
        <span>Z</span> å·¦å›è»¢<br>
        <span>C</span> 180Â°<br>
        <span>â†“</span> ã‚½ãƒ•ãƒˆè½ä¸‹<br>
        <span>Space</span> ãƒãƒ¼ãƒ‰è½ä¸‹<br>
        <span>Shift</span> ãƒ›ãƒ¼ãƒ«ãƒ‰<br>
        <span>E</span> EXIT<br>
        <span>V</span> CONTINUE
      </div>
    </div>
  </div>
</div>
<div id="gp-status"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const COLS=10, ROWS=17, BS=30; // BS = block size
const MAX_LV=8, TARGET=50;
const ANOMALY_RATE=0.7;

const gc   =document.getElementById('gc');   const ctx  =gc.getContext('2d');
const hc   =document.getElementById('hold-c');const hCtx=hc.getContext('2d');
const nc   =document.getElementById('next-c');const nCtx=nc.getContext('2d');
const n2c  =document.getElementById('next2-c');const n2Ctx=n2c.getContext('2d');

// ============================================================
// PIECES & SRS
// ============================================================
const TYPES=['I','O','T','S','Z','J','L'];
const COLORS={I:'#00f5ff',O:'#ffe600',T:'#bf00ff',S:'#00ff88',Z:'#ff2244',J:'#0066ff',L:'#ff8800'};
const SHAPES={
  I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  O:[[1,1],[1,1]],
  T:[[0,1,0],[1,1,1],[0,0,0]],
  S:[[0,1,1],[1,1,0],[0,0,0]],
  Z:[[1,1,0],[0,1,1],[0,0,0]],
  J:[[1,0,0],[1,1,1],[0,0,0]],
  L:[[0,0,1],[1,1,1],[0,0,0]]
};
// SRS kick tables (dy is board-up = negative)
const KK={
  '0>1':[[ 0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],
  '1>0':[[ 0,0],[ 1,0],[ 1,-1],[0, 2],[ 1, 2]],
  '1>2':[[ 0,0],[ 1,0],[ 1,-1],[0, 2],[ 1, 2]],
  '2>1':[[ 0,0],[-1,0],[-1, 1],[0,-2],[-1,-2]],
  '2>3':[[ 0,0],[ 1,0],[ 1, 1],[0,-2],[ 1,-2]],
  '3>2':[[ 0,0],[-1,0],[-1,-1],[0, 2],[-1, 2]],
  '3>0':[[ 0,0],[-1,0],[-1,-1],[0, 2],[-1, 2]],
  '0>3':[[ 0,0],[ 1,0],[ 1, 1],[0,-2],[ 1,-2]],
};
const KI={
  '0>1':[[ 0,0],[-2,0],[ 1,0],[-2,-1],[ 1,2]],
  '1>0':[[ 0,0],[ 2,0],[-1,0],[ 2, 1],[-1,-2]],
  '1>2':[[ 0,0],[-1,0],[ 2,0],[-1, 2],[ 2,-1]],
  '2>1':[[ 0,0],[ 1,0],[-2,0],[ 1,-2],[-2, 1]],
  '2>3':[[ 0,0],[ 2,0],[-1,0],[ 2, 1],[-1,-2]],
  '3>2':[[ 0,0],[-2,0],[ 1,0],[-2,-1],[ 1, 2]],
  '3>0':[[ 0,0],[ 1,0],[-2,0],[ 1,-2],[-2, 1]],
  '0>3':[[ 0,0],[-1,0],[ 2,0],[-1, 2],[ 2,-1]],
};

// 7-bag randomiser
let bag=[];
function fromBag(){
  if(!bag.length){bag=[...TYPES];for(let i=bag.length-1;i>0;i--){const j=0|Math.random()*(i+1);[bag[i],bag[j]]=[bag[j],bag[i]];}}
  return bag.pop();
}
function mkPiece(t){
  if(!t)t=fromBag();
  const m=SHAPES[t].map(r=>[...r]);
  return{type:t,color:COLORS[t],matrix:m,state:0,x:Math.floor((COLS-m[0].length)/2),y:t==='I'?-1:0};
}

// ============================================================
// STATE
// ============================================================
const G={
  board:null, cur:null, held:null, queue:[],
  lines:0, level:1,
  active:false, over:false,
  holdUsed:false,
  dropTmr:null, lockTmr:null, lockMoves:0,
  hasAnom:false, anomLine:0, anomActive:false, anomDef:null,
  // visual overrides
  hideNext:false,hideHold:false,hideGhost:false,hideGrid:false,
  shake:false,dark:false,ghostBoard:false,narrow:false,
  monoColor:null,pieceColor:null,borderColor:null,
  speedMult:1,revCtrl:false,revRot:false,
  hideExit:false,hideCont:false,
  fakeLines:null,fakeLv:null,fakeProg:null,fakeTitle:null,fakeAnom:null,
};

// ============================================================
// BOARD / PIECE HELPERS
// ============================================================
function mkBoard(){return Array.from({length:ROWS},()=>Array(COLS).fill(0));}
function valid(p,dx=0,dy=0,m=null){
  m=m||p.matrix;
  for(let r=0;r<m.length;r++)for(let c=0;c<m[r].length;c++){
    if(!m[r][c])continue;
    const nx=p.x+c+dx,ny=p.y+r+dy;
    if(nx<0||nx>=COLS||ny>=ROWS)return false;
    if(ny>=0&&G.board[ny][nx])return false;
  }
  return true;
}
function rotCWmat(m){return m[0].map((_,i)=>m.map(r=>r[i]).reverse());}
function rotCCWmat(m){return m[0].map((_,i)=>m.map(r=>r[r.length-1-i]));}

function tryRot(dir){
  if(!G.active||!G.cur)return;
  const eff=G.revRot?-dir:dir;
  const ns=((G.cur.state+(eff===1?1:3))%4);
  const nm=eff===1?rotCWmat(G.cur.matrix):rotCCWmat(G.cur.matrix);
  const key=`${G.cur.state}>${ns}`;
  const kicks=G.cur.type==='I'?KI:KK;
  const tests=kicks[key]||[[0,0]];
  for(const[kx,ky]of tests){
    if(valid(G.cur,kx,-ky,nm)){
      G.cur.matrix=nm;G.cur.state=ns;G.cur.x+=kx;G.cur.y-=ky;
      resetLock();render();return;
    }
  }
}
function tryRot180(){
  if(!G.active||!G.cur)return;
  const m=rotCWmat(rotCWmat(G.cur.matrix));
  if(valid(G.cur,0,0,m)){G.cur.matrix=m;G.cur.state=(G.cur.state+2)%4;resetLock();render();}
}

// ============================================================
// LOCK DELAY
// ============================================================
function resetLock(){
  if(G.lockMoves<15){
    clearTimeout(G.lockTmr);
    G.lockTmr=setTimeout(lock,500);
    G.lockMoves++;
  }
}
function lock(){
  clearTimeout(G.lockTmr);G.lockMoves=0;
  const p=G.cur;
  p.matrix.forEach((row,r)=>row.forEach((v,c)=>{if(v&&p.y+r>=0)G.board[p.y+r][p.x+c]=p.color;}));
  const cl=clearLines();
  G.lines+=cl;
  if(G.hasAnom&&!G.anomActive&&G.lines>=G.anomLine)activateAnom();
  if(G.lines>=TARGET){
    clearInterval(G.dropTmr);G.active=false;
    if(G.hasAnom){showResult(false,'ç•°å¤‰ãŒã‚ã£ãŸã®ã«\n50ãƒ©ã‚¤ãƒ³æ¶ˆã—ã¦ã—ã¾ã£ãŸã€‚');}
    else levelUp();
    return;
  }
  G.cur=G.queue.shift();G.queue.push(mkPiece());G.holdUsed=false;
  if(!valid(G.cur)){showResult(false,'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒåŸ‹ã¾ã£ãŸï¼');return;}
  updateUI();restartDrop();render();
}
function clearLines(){
  let n=0;
  for(let r=ROWS-1;r>=0;r--){
    if(G.board[r].every(c=>c)){G.board.splice(r,1);G.board.unshift(Array(COLS).fill(0));n++;r++;}
  }
  return n;
}

// ============================================================
// GHOST
// ============================================================
function ghostY(){let dy=0;while(valid(G.cur,0,dy+1))dy++;return G.cur.y+dy;}

// ============================================================
// HOLD
// ============================================================
function doHold(){
  if(!G.active||G.holdUsed)return;
  G.holdUsed=true;
  const prev=G.held;
  G.held=mkPiece(G.cur.type);
  if(prev){G.cur=mkPiece(prev.type);}
  else{G.cur=G.queue.shift();G.queue.push(mkPiece());}
  if(!valid(G.cur)){showResult(false,'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒåŸ‹ã¾ã£ãŸï¼');return;}
  clearTimeout(G.lockTmr);G.lockMoves=0;
  restartDrop();render();
}

// ============================================================
// DROP
// ============================================================
function dropMs(){return Math.max(80,900-(G.level-1)*100)*G.speedMult;}
function restartDrop(){
  clearInterval(G.dropTmr);
  if(G.active){
    G.dropTmr=setInterval(()=>{
      if(!valid(G.cur,0,1)){clearTimeout(G.lockTmr);G.lockTmr=setTimeout(lock,500);}
      else{G.cur.y++;clearTimeout(G.lockTmr);render();}
    },dropMs());
  }
}
function softDrop(){
  if(!G.active)return;
  if(valid(G.cur,0,1)){G.cur.y++;clearTimeout(G.lockTmr);render();}
  else{clearTimeout(G.lockTmr);G.lockTmr=setTimeout(lock,500);}
}
function hardDrop(){
  if(!G.active)return;
  clearInterval(G.dropTmr);clearTimeout(G.lockTmr);G.lockMoves=0;
  G.cur.y=ghostY();lock();
}
function mvL(){
  if(!G.active||!G.cur)return;
  const d=G.revCtrl?1:-1;
  if(valid(G.cur,d,0)){G.cur.x+=d;resetLock();render();}
}
function mvR(){
  if(!G.active||!G.cur)return;
  const d=G.revCtrl?-1:1;
  if(valid(G.cur,d,0)){G.cur.x+=d;resetLock();render();}
}

// ============================================================
// ROUND MANAGEMENT
// ============================================================
function resetOv(){
  G.hideNext=G.hideHold=G.hideGhost=G.hideGrid=G.shake=G.dark=G.ghostBoard=G.narrow=false;
  G.monoColor=G.pieceColor=G.borderColor=null;
  G.speedMult=1;G.revCtrl=G.revRot=false;
  G.hideExit=G.hideCont=false;
  G.fakeLines=G.fakeLv=G.fakeProg=G.fakeTitle=G.fakeAnom=null;
}
function startRound(){
  G.board=mkBoard();G.lines=0;G.active=true;G.over=false;
  G.held=null;G.holdUsed=false;bag=[];
  G.queue=[mkPiece(),mkPiece(),mkPiece()];
  G.cur=G.queue.shift();G.queue.push(mkPiece());
  G.anomActive=false;G.anomDef=null;
  G.hasAnom=Math.random()<ANOMALY_RATE;
  G.anomLine=5+Math.floor(Math.random()*20);
  resetOv();
  document.getElementById('overlay').style.display='none';
  document.getElementById('anomaly-hint').textContent='';
  document.getElementById('anomaly-hint').className='';
  gc.className='';
  updateUI();restartDrop();render();
}

// ============================================================
// PLAYER DECISION
// ============================================================
function playerExit(){
  if(!G.active)return;
  clearInterval(G.dropTmr);clearTimeout(G.lockTmr);G.active=false;
  if(G.hasAnom)levelUp();
  else showResult(false,'ç•°å¤‰ã¯ãªã‹ã£ãŸâ€¦\nEXITã‚’é¸ã‚“ã§ã—ã¾ã£ãŸã€‚');
}
function playerContinue(){
  if(!G.active)return;
  // Just keep playing; result evaluated at 50 lines
}
function levelUp(){
  G.level++;resetOv();
  if(G.level>MAX_LV)showClear();
  else showResult(true,`LEVEL ${G.level-1} â†’ ${G.level}!`);
}
function showResult(ok,msg){
  G.active=false;clearInterval(G.dropTmr);clearTimeout(G.lockTmr);
  resetOv();gc.className='';
  const ol=document.getElementById('overlay');
  const t=document.getElementById('ov-title');
  const m=document.getElementById('ov-msg');
  const b=document.getElementById('start-btn');
  t.className='';
  if(ok){
    t.textContent='âœ“ CORRECT';t.classList.add('result-good');
    m.textContent=msg;b.textContent='æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰';
  } else {
    t.textContent='âœ— WRONG';t.classList.add('result-bad');
    const aname=G.anomDef?`\n\nï¼ˆç•°å¤‰ï¼šã€Œ${G.anomDef.name}ã€ï¼‰`:G.hasAnom?'\n\nï¼ˆç•°å¤‰ã¯ç™ºç”Ÿã—ã¦ã„ãŸï¼‰':'';
    m.textContent=msg+aname;b.textContent='ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ (Lv.1)';G.level=1;
  }
  ol.style.display='flex';updateUI();
}
function showClear(){
  G.active=false;clearInterval(G.dropTmr);clearTimeout(G.lockTmr);
  const t=document.getElementById('ov-title');
  const m=document.getElementById('ov-msg');
  const b=document.getElementById('start-btn');
  t.className='result-clear';t.textContent='ğŸ‰ CLEAR!';
  m.textContent='ãƒ¬ãƒ™ãƒ« 8 çªç ´ï¼è„±å‡ºæˆåŠŸï¼\nãŠã‚ã§ã¨ã†ï¼';
  b.textContent='ã‚‚ã†ä¸€åº¦';G.level=1;
  document.getElementById('overlay').style.display='flex';updateUI();
}

// ============================================================
// ANOMALY ENGINE  (50ç¨®é¡, 70%ç™ºç”Ÿ)
// ============================================================
const ANOMS=[
  {id:1, name:'å…¨ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚°ãƒ¬ãƒ¼ã«', apply:()=>{G.board.forEach(r=>r.forEach((c,i,a)=>{if(c)a[i]='#888';}));}},
  {id:2, name:'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒé€†ã•ã¾ã«', apply:()=>{G.board.reverse();}},
  {id:3, name:'æ¨ªä¸€è¡ŒãŒçªç„¶åŸ‹ã¾ã‚‹', apply:()=>{const r=Math.floor(Math.random()*(ROWS-5));G.board[r]=G.board[r].map(c=>c||'#334');}},
  {id:4, name:'ä¸€åˆ—ãŒæ¶ˆãˆã‚‹', apply:()=>{const c=0|Math.random()*COLS;G.board.forEach(r=>r[c]=0);}},
  {id:5, name:'ãƒã‚§ãƒƒã‚«ãƒ¼æ¨¡æ§˜', apply:()=>{for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if((r+c)%2===0&&!G.board[r][c])G.board[r][c]='#1a3';}},
  {id:6, name:'å¤©äº•ãŒ3è¡Œä¸‹ãŒã‚‹', apply:()=>{for(let r=0;r<3;r++)for(let c=0;c<COLS;c++)G.board[r][c]='#334';}},
  {id:7, name:'ä¸­å¤®åˆ—ãŒåŸ‹ã¾ã‚‹', apply:()=>{G.board.forEach(r=>r[4]='#334');}},
  {id:8, name:'åº•ã«è¡ŒãŒå‡ºç¾', apply:()=>{const row=Array(COLS).fill('#2a4');row[0|Math.random()*COLS]=0;G.board[ROWS-1]=row;}},
  {id:9, name:'ãƒ©ãƒ³ãƒ€ãƒ ãƒ–ãƒ­ãƒƒã‚¯å‡ºç¾', apply:()=>{for(let i=0;i<5;i++){const r=2+(0|Math.random()*(ROWS-4)),c=0|Math.random()*COLS;if(!G.board[r][c])G.board[r][c]='#3a5';}}},
  {id:10,name:'å·¦ç«¯ã«å¡”', apply:()=>{for(let r=ROWS-8;r<ROWS;r++)G.board[r][0]='#36a';}},
  {id:11,name:'å…¨ãƒ–ãƒ­ãƒƒã‚¯ãŒæ¶ˆãˆã‚‹', apply:()=>{G.board=mkBoard();}},
  {id:12,name:'ãƒŸãƒ©ãƒ¼åè»¢', apply:()=>{G.board.forEach(r=>r.reverse());}},
  {id:13,name:'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ1è¡Œãšã‚Œã‚‹', apply:()=>{G.board.unshift(G.board.pop());}},
  {id:14,name:'2è¡ŒãŒæ¶ˆãˆã‚‹', apply:()=>{const r1=1+(0|Math.random()*(ROWS-3));G.board[r1]=Array(COLS).fill(0);if(r1+2<ROWS)G.board[r1+2]=Array(COLS).fill(0);}},
  {id:15,name:'ãƒãƒ¼ãƒˆå‹ãŒå‡ºç¾', apply:()=>{const p=[[0,1,0,1,0],[1,1,1,1,1],[1,1,1,1,1],[0,1,1,1,0],[0,0,1,0,0]];p.forEach((row,r)=>row.forEach((v,c)=>{if(v&&5+r<ROWS)G.board[5+r][2+c]='#f24';}));}},
  {id:16,name:'éšæ®µçŠ¶ãƒ–ãƒ­ãƒƒã‚¯', apply:()=>{for(let i=0;i<7;i++)if(ROWS-1-i>=0&&i<COLS)G.board[ROWS-1-i][i]='#4a6';}},
  {id:17,name:'ä¸€åˆ—ã ã‘èµ¤ã', apply:()=>{const c=0|Math.random()*COLS;G.board.forEach(r=>{if(r[c])r[c]='#f24';});}},
  {id:18,name:'Xå‹å‡ºç¾', apply:()=>{for(let d=-3;d<=3;d++){const cy=8,cx=4;if(cy+d>=0&&cy+d<ROWS){if(cx+d>=0&&cx+d<COLS)G.board[cy+d][cx+d]='#46f';if(cx-d>=0&&cx-d<COLS)G.board[cy+d][cx-d]='#46f';}}}},
  {id:19,name:'å¸‚æ¾åŸ‹ã‚', apply:()=>{for(let r=2;r<ROWS;r+=2)for(let c=0;c<5;c++)if(!G.board[r][c])G.board[r][c]='#1a3';}},
  {id:20,name:'å³ç«¯2åˆ—ãŒæš—ããªã‚‹', apply:()=>{G.narrow=true;}},
  {id:21,name:'NEXTãŒå¤‰ã‚ã‚‹', apply:()=>{const t=TYPES.filter(x=>x!==G.queue[0].type);G.queue[0]=mkPiece(t[0|Math.random()*t.length]);}},
  {id:22,name:'NEXTãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideNext=true;}},
  {id:23,name:'HOLDãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideHold=true;}},
  {id:24,name:'NEXT=IãƒŸãƒå›ºå®š', apply:()=>{G.queue[0]=mkPiece('I');}},
  {id:25,name:'NEXT=OãƒŸãƒå›ºå®š', apply:()=>{G.queue[0]=mkPiece('O');}},
  {id:26,name:'NEXT=ZãƒŸãƒå›ºå®š', apply:()=>{G.queue[0]=mkPiece('Z');}},
  {id:27,name:'ãƒŸãƒãŒæ¨ªã«ãšã‚Œã‚‹', apply:()=>{const dx=(Math.random()>.5?1:-1)*(1+(0|Math.random()*3));const np=G.cur.x+dx;if(np>=0&&np+G.cur.matrix[0].length<=COLS)G.cur.x=np;}},
  {id:28,name:'ãƒŸãƒãŒçªç„¶å›è»¢', apply:()=>{const m=rotCWmat(G.cur.matrix);if(valid(G.cur,0,0,m)){G.cur.matrix=m;G.cur.state=(G.cur.state+1)%4;}}},
  {id:29,name:'ãƒŸãƒã®è‰²ãŒå¤‰ã‚ã‚‹', apply:()=>{const cols=Object.values(COLORS).filter(c=>c!==G.cur.color);G.pieceColor=cols[0|Math.random()*cols.length];}},
  {id:30,name:'è½ä¸‹é€Ÿåº¦ãŒ2å€', apply:()=>{G.speedMult=0.3;restartDrop();}},
  {id:31,name:'è½ä¸‹é€Ÿåº¦ãŒæ¿€é…', apply:()=>{G.speedMult=5;restartDrop();}},
  {id:32,name:'å·¦å³æ“ä½œãŒé€†è»¢', apply:()=>{G.revCtrl=true;}},
  {id:33,name:'å›è»¢æ–¹å‘ãŒé€†è»¢', apply:()=>{G.revRot=true;}},
  {id:34,name:'ã‚´ãƒ¼ã‚¹ãƒˆãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideGhost=true;}},
  {id:35,name:'ã‚°ãƒªãƒƒãƒ‰ãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideGrid=true;}},
  {id:36,name:'ç”»é¢ãŒæš—ããªã‚‹', apply:()=>{G.dark=true;}},
  {id:37,name:'å…¨ãƒ–ãƒ­ãƒƒã‚¯ãŒç™½ã', apply:()=>{G.monoColor='#fff';}},
  {id:38,name:'ãƒ–ãƒ­ãƒƒã‚¯ãŒé€æ˜åŒ–', apply:()=>{G.ghostBoard=true;}},
  {id:39,name:'ç”»é¢ãŒæºã‚Œã‚‹', apply:()=>{G.shake=true;}},
  {id:40,name:'å¤–æ ã®è‰²ãŒå¤‰ã‚ã‚‹', apply:()=>{G.borderColor='#f80';}},
  {id:41,name:'ãƒ©ã‚¤ãƒ³æ•°ãŒ0ã«', apply:()=>{G.fakeLines=0;}},
  {id:42,name:'ãƒ©ã‚¤ãƒ³æ•°ãŒ50ä»¥ä¸Š', apply:()=>{G.fakeLines=50;}},
  {id:43,name:'ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºãŒå¤‰ã‚ã‚‹', apply:()=>{G.fakeLv=G.level+2;}},
  {id:44,name:'ãƒ¬ãƒ™ãƒ«ãŒ0ã«', apply:()=>{G.fakeLv=0;}},
  {id:45,name:'é€²æ—ãƒãƒ¼ãŒæº€ã‚¿ãƒ³', apply:()=>{G.fakeProg=100;}},
  {id:46,name:'é€²æ—ãƒãƒ¼ãŒç©ºã«', apply:()=>{G.fakeProg=0;}},
  {id:47,name:'ã‚¿ã‚¤ãƒˆãƒ«ãŒå¤‰ã‚ã‚‹', apply:()=>{G.fakeTitle='8ç•ªå‡ºå£';}},
  {id:48,name:'ANOMALYæ¬„ã«æ•°å­—', apply:()=>{G.fakeAnom=1+(0|Math.random()*4);}},
  {id:49,name:'EXITãƒœã‚¿ãƒ³ãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideExit=true;}},
  {id:50,name:'CONTINUEãŒæ¶ˆãˆã‚‹', apply:()=>{G.hideCont=true;}},
];
function activateAnom(){
  const def=ANOMS[0|Math.random()*ANOMS.length];
  G.anomDef=def;G.anomActive=true;
  def.apply();
  gc.classList.add('anomaly-border');
  const h=document.getElementById('anomaly-hint');
  h.textContent='âš  ç•°å¤‰ã‚’æ„ŸçŸ¥ï¼';h.className='blinking';
}

// ============================================================
// UI
// ============================================================
function updateUI(){
  const lines=G.fakeLines!==null?G.fakeLines:G.lines;
  const lv=G.fakeLv!==null?G.fakeLv:G.level;
  const prog=G.fakeProg!==null?G.fakeProg:Math.min(100,(G.lines/TARGET)*100);
  document.getElementById('lines-val').textContent=lines;
  document.getElementById('level-val').textContent=lv;
  const fill=document.getElementById('anomaly-fill');
  fill.style.width=prog+'%';
  fill.style.background=prog>75?'#f80':'#0f8';
  fill.style.boxShadow=prog>75?'0 0 6px #f80':'0 0 6px #0f8';
  const se=document.getElementById('level-stars');
  se.innerHTML='';
  for(let i=1;i<=MAX_LV;i++){const s=document.createElement('div');s.className='star'+(i<G.level?' lit':'');se.appendChild(s);}
  document.getElementById('main-title').textContent=G.fakeTitle||'EXIT No. TETRIS';
  document.getElementById('anomaly-count').textContent=G.fakeAnom!==null?G.fakeAnom:'???';
  document.getElementById('exit-btn').style.opacity=G.hideExit?'0':'1';
  document.getElementById('cont-btn').style.opacity=G.hideCont?'0':'1';
}

// ============================================================
// RENDER
// ============================================================
function lighten(h,a){
  if(!h||h[0]!=='#')return h;
  const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);
  const l=v=>Math.min(255,0|v+(255-v)*a);
  return`rgb(${l(r)},${l(g)},${l(b)})`;
}
function dBlock(c,x,y,sz,col,a=1){
  const bx=x*sz,by=y*sz;
  c.save();c.globalAlpha=a;
  c.fillStyle='rgba(0,0,0,0.35)';c.fillRect(bx+1,by+1,sz-2,sz-2);
  const g=c.createLinearGradient(bx,by,bx+sz,by+sz);
  g.addColorStop(0,lighten(col,0.3));g.addColorStop(1,col);
  c.fillStyle=g;c.fillRect(bx+1,by+1,sz-2,sz-2);
  c.strokeStyle=lighten(col,0.55);c.lineWidth=1;c.strokeRect(bx+2,by+2,sz-4,sz-4);
  c.restore();
}
function dMini(c,piece,cw,ch){
  const sz=20;c.clearRect(0,0,cw,ch);
  if(!piece)return;
  const pw=piece.matrix[0].length*sz,ph=piece.matrix.length*sz;
  const ox=Math.floor((cw-pw)/2/sz),oy=Math.floor((ch-ph)/2/sz);
  piece.matrix.forEach((row,r)=>row.forEach((v,col)=>{
    if(v){c.shadowColor=piece.color;c.shadowBlur=6;dBlock(c,ox+col,oy+r,sz,piece.color);c.shadowBlur=0;}
  }));
}
function render(){
  ctx.clearRect(0,0,gc.width,gc.height);
  if(G.dark){ctx.fillStyle='rgba(0,0,0,0.55)';ctx.fillRect(0,0,gc.width,gc.height);}
  if(!G.hideGrid){
    ctx.strokeStyle='rgba(20,40,80,0.45)';ctx.lineWidth=0.5;
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)ctx.strokeRect(c*BS,r*BS,BS,BS);
  }
  if(G.narrow){ctx.fillStyle='rgba(20,20,40,0.72)';ctx.fillRect(8*BS,0,2*BS,ROWS*BS);}
  G.board.forEach((row,r)=>row.forEach((col,c)=>{
    if(col){
      const cl=G.monoColor||col;
      ctx.shadowColor=cl;ctx.shadowBlur=G.ghostBoard?0:5;
      dBlock(ctx,c,r,BS,cl,G.ghostBoard?0.2:1);ctx.shadowBlur=0;
    }
  }));
  if(!G.hideGhost&&G.cur&&G.active){
    const gy=ghostY();
    G.cur.matrix.forEach((row,r)=>row.forEach((v,c)=>{
      if(v&&gy+r>=0)dBlock(ctx,G.cur.x+c,gy+r,BS,G.cur.color,0.13);
    }));
  }
  if(G.cur&&G.active){
    const col=G.pieceColor||G.cur.color;
    G.cur.matrix.forEach((row,r)=>row.forEach((v,c)=>{
      if(v&&G.cur.y+r>=0){ctx.shadowColor=col;ctx.shadowBlur=14;dBlock(ctx,G.cur.x+c,G.cur.y+r,BS,col);ctx.shadowBlur=0;}
    }));
  }
  dMini(hCtx,G.hideHold?null:G.held,hc.width,hc.height);
  dMini(nCtx,G.hideNext?null:G.queue[0],nc.width,nc.height);
  dMini(n2Ctx,G.hideNext?null:G.queue[1],n2c.width,n2c.height);
  if(G.shake){const dx=(Math.random()-.5)*3,dy=(Math.random()-.5)*3;gc.style.transform=`translate(${dx}px,${dy}px)`;}
  else gc.style.transform='';
  gc.style.borderColor=G.borderColor||'';
  updateUI();
}

// ============================================================
// KEYBOARD   (DAS/ARR)
// ============================================================
const KBD={DAS:133,ARR:10};
const hk={};const dt={};
function kbdAct(code){
  switch(code){
    case'ArrowLeft':  mvL();break;
    case'ArrowRight': mvR();break;
    case'ArrowDown':  softDrop();break;
    case'ArrowUp':    tryRot(1);break;
    case'KeyX':       tryRot(1);break;
    case'KeyZ':       tryRot(-1);break;
    case'KeyC':       tryRot180();break;
    case'Space':      hardDrop();break;
    case'ShiftLeft':case'ShiftRight':case'ControlLeft':case'ControlRight':doHold();break;
    case'KeyE':       playerExit();break;
    case'KeyV':       playerContinue();break;
    case'Enter':
      if(document.getElementById('overlay').style.display!=='none')startRound();
      break;
  }
}
document.addEventListener('keydown',e=>{
  const c=e.code;
  if(['ArrowLeft','ArrowRight','ArrowDown','ArrowUp','Space'].includes(e.key))e.preventDefault();
  if(hk[c])return;
  hk[c]=true;kbdAct(c);
  if(['ArrowLeft','ArrowRight','ArrowDown'].includes(e.key)){
    dt[c]=setTimeout(()=>{dt[c+'r']=setInterval(()=>{if(hk[c])kbdAct(c);},KBD.ARR);},KBD.DAS);
  }
});
document.addEventListener('keyup',e=>{
  const c=e.code;hk[c]=false;clearTimeout(dt[c]);clearInterval(dt[c+'r']);
});

// ============================================================
// GAMEPAD
// ============================================================
// Layout (Standard Gamepad API):
//   Buttons:
//     0=A(Ã—)  1=B(â—‹)  2=X(â–¡)  3=Y(â–³)
//     4=LB    5=RB    6=LT    7=RT
//     8=Select/Share  9=Start/Options
//     12=D-Up  13=D-Down  14=D-Left  15=D-Right
//   Axes: 0=LS-X  1=LS-Y
//
//   Move Left/Right : D-Left/Right, LS-X
//   Soft Drop       : D-Down, LS-Down
//   Hard Drop       : D-Up
//   Rotate CW       : A(0), B(1)   â† å³å´4ãƒœã‚¿ãƒ³ä¸Š/å³ = å³å›è»¢
//   Rotate CCW      : X(2)         â† å³å´4ãƒœã‚¿ãƒ³å·¦   = å·¦å›è»¢
//   Rotate 180      : Y(3)         â† å³å´4ãƒœã‚¿ãƒ³ä¸Š   = 180Â°
//   Hold            : LB(4), RB(5)
//   EXIT            : LT(6), Select(8)
//   CONTINUE        : RT(7)
//   Start game      : Start(9) [at overlay]

const GP={DAS:133,ARR:10,ok:false,idx:null,prev:{}};
const gpT={};

window.addEventListener('gamepadconnected',e=>{
  try{
    GP.ok=true;GP.idx=e.gamepad.index;GP.prev={};
    gpStatus(true,e.gamepad.id);requestAnimationFrame(gpLoop);
  }catch(err){console.warn('Gamepad not available:',err);}
});
window.addEventListener('gamepaddisconnected',e=>{
  try{
    if(e.gamepad.index!==GP.idx)return;
    GP.ok=false;GP.idx=null;
    clearTimeout(gpT.lDAS);clearInterval(gpT.lREP);
    clearTimeout(gpT.rDAS);clearInterval(gpT.rREP);
    clearTimeout(gpT.dDAS);clearInterval(gpT.dREP);
    gpStatus(false,'');
  }catch(err){}
});
function gpStatus(on,id){
  const el=document.getElementById('gp-status');
  if(on){
    el.style.cssText='position:fixed;bottom:10px;right:14px;font-family:"Share Tech Mono",monospace;font-size:0.55rem;letter-spacing:0.1em;padding:4px 9px;border-radius:2px;z-index:1000;opacity:1;transition:opacity 0.5s;background:rgba(0,255,136,0.12);border:1px solid #0f8;color:#0f8;';
    el.textContent='ğŸ® '+(id.length>28?id.slice(0,28)+'â€¦':id);
  }else{
    el.style.cssText='position:fixed;bottom:10px;right:14px;font-family:"Share Tech Mono",monospace;font-size:0.55rem;letter-spacing:0.1em;padding:4px 9px;border-radius:2px;z-index:1000;opacity:1;transition:opacity 0.5s;background:rgba(255,34,68,0.12);border:1px solid #f24;color:#f24;';
    el.textContent='ğŸ® åˆ‡æ–­';setTimeout(()=>el.style.opacity='0',3000);
  }
}
function axd(v,t=0.4){return v<-t?-1:v>t?1:0;}
function bp(b,i){return b[i]&&b[i].pressed;}
function jd(b,p,i){return bp(b,i)&&!p['b'+i];}

function gpLoop(){
  if(!GP.ok)return;
  let pads;
  try{pads=navigator.getGamepads();}catch(e){GP.ok=false;return;}
  const pad=pads[GP.idx];
  if(!pad){requestAnimationFrame(gpLoop);return;}
  const b=pad.buttons,ax=pad.axes,pv=GP.prev;

  const dL=bp(b,14)||axd(ax[0])===-1;
  const dR=bp(b,15)||axd(ax[0])===1;
  const dD=bp(b,13)||axd(ax[1])===1;

  // Left
  if(dL&&!pv._dL){mvL();clearTimeout(gpT.lDAS);clearInterval(gpT.lREP);gpT.lDAS=setTimeout(()=>{gpT.lREP=setInterval(mvL,GP.ARR);},GP.DAS);}
  if(!dL&&pv._dL){clearTimeout(gpT.lDAS);clearInterval(gpT.lREP);}
  // Right
  if(dR&&!pv._dR){mvR();clearTimeout(gpT.rDAS);clearInterval(gpT.rREP);gpT.rDAS=setTimeout(()=>{gpT.rREP=setInterval(mvR,GP.ARR);},GP.DAS);}
  if(!dR&&pv._dR){clearTimeout(gpT.rDAS);clearInterval(gpT.rREP);}
  // Soft drop
  if(dD&&!pv._dD){softDrop();clearTimeout(gpT.dDAS);clearInterval(gpT.dREP);gpT.dDAS=setTimeout(()=>{gpT.dREP=setInterval(softDrop,GP.ARR);},GP.DAS);}
  if(!dD&&pv._dD){clearTimeout(gpT.dDAS);clearInterval(gpT.dREP);}
  // Hard drop: D-Up
  if(jd(b,pv,12))hardDrop();
  // Rotate: A(0)=CW, B(1)=CW, X(2)=CCW, Y(3)=180
  if(jd(b,pv,0))tryRot(1);
  if(jd(b,pv,1))tryRot(1);
  if(jd(b,pv,2))tryRot(-1);
  if(jd(b,pv,3))tryRot180();
  // Hold: LB(4) or RB(5)
  if(jd(b,pv,4)||jd(b,pv,5))doHold();
  // EXIT: LT(6) or Select(8)
  if(jd(b,pv,6)||jd(b,pv,8))playerExit();
  // CONTINUE: RT(7)
  if(jd(b,pv,7))playerContinue();
  // Start(9)
  if(jd(b,pv,9)&&document.getElementById('overlay').style.display!=='none')startRound();

  // save prev
  GP.prev={};
  b.forEach((x,i)=>GP.prev['b'+i]=x.pressed);
  GP.prev._dL=dL;GP.prev._dR=dR;GP.prev._dD=dD;
  requestAnimationFrame(gpLoop);
}

// ============================================================
// BUTTON EVENTS
// ============================================================
document.getElementById('exit-btn').addEventListener('click',playerExit);
document.getElementById('cont-btn').addEventListener('click',playerContinue);
document.getElementById('start-btn').addEventListener('click',startRound);

// Initial draw
G.board=mkBoard();render();
</script>
</body>
</html>
